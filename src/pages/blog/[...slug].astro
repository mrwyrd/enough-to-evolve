---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import { SITE } from '../../consts';
import { estimateReadingTime } from '../../utils/readingTime';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map((post) => ({ params: { slug: post.slug }, props: { post } }));
}

const { post } = Astro.props;
const { Content } = await render(post);
const reading = estimateReadingTime(post.body ?? '');

const canonical = `${SITE.url}/blog/${post.slug}/`;

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title,
  description: post.data.description,
  datePublished: post.data.pubDate.toISOString(),
  dateModified: (post.data.updatedDate ?? post.data.pubDate).toISOString(),
  author: [{ '@type': 'Person', name: SITE.author }],
  publisher: { '@type': 'Organization', name: SITE.name },
  mainEntityOfPage: { '@type': 'WebPage', '@id': canonical },
};
---

<BaseLayout title={post.data.title} description={post.data.description} canonical={canonical} type="article">
  <article class="prose">
    <div class="post-meta">
      <span>{post.data.pubDate.toLocaleDateString()}</span>
      <span aria-hidden="true">â€¢</span>
      <span>{reading.minutes} min read</span>
    </div>
    <h1>{post.data.title}</h1>

    {post.data.tags?.length ? (
      <div class="tag-chips" style="margin: 12px 0 0">
        {post.data.tags.map((t) => (
          <a class="tag-chip" href={`/tags/${t}/`}>{t}</a>
        ))}
      </div>
    ) : null}

    <Content />

    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  </article>
</BaseLayout>
